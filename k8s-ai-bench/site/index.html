<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>k8s-ai-bench Leaderboard</title>
	<style>
	body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f6f8fa; color: #24292e; display: flex; flex-direction: column; min-height: 100vh; }
	.navbar { background-color: #24292e; padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
	.nav-brand { color: white; font-weight: bold; font-size: 1.2rem; text-decoration: none; margin-right: 2rem; }
	.nav-links { display: flex; gap: 1rem; }
	.nav-btn { color: rgba(255,255,255,0.7); text-decoration: none; font-weight: 600; padding: 0.5rem 1rem; border-radius: 6px; transition: all 0.2s; font-size: 0.9rem; }
	.nav-btn:hover { color: white; background-color: rgba(255,255,255,0.1); }
	.nav-btn.active { color: white; background-color: #0969da; }
	.container { max-width: 1200px; margin: 0 auto; padding: 2rem; width: 100%; box-sizing: border-box; flex: 1; }
	h1, h2 { text-align: center; font-weight: 600; border-bottom: 1px solid #e1e4e8; padding-bottom: 0.5em; margin-top: 1em; }
	table { width: 100%; border-collapse: collapse; margin: 20px auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background-color: #fff; table-layout: fixed; }
	th, td { border: 1px solid #dfe2e5; padding: 12px 15px; text-align: left; vertical-align: middle; }
	th { background-color: #f6f8fa; font-weight: 600; cursor: pointer; user-select: none; position: relative; }
	th:hover { background-color: #eaeef2; }
	tr:nth-child(even) { background-color: #f6f8fa; }
	th::after { content: ' \2195'; position: absolute; right: 8px; opacity: 0.3; font-size: 0.8em; }
	th.asc::after { content: ' \2191'; opacity: 1; }
	th.desc::after { content: ' \2193'; opacity: 1; }
	.intro-container { max-width: 800px; margin: 0 auto 2rem auto; text-align: left; color: #57606a; background-color: #fff; padding: 1.5rem; border: 1px solid #e1e4e8; border-radius: 6px; margin-bottom: 2rem; }
	.intro-row { margin-bottom: 0.5rem; line-height: 1.5; }
	.intro-label { font-weight: 600; color: #24292e; margin-right: 5px; }
	.metric-def { margin-bottom: 5px; font-size: 0.95em; }
	.controls-area { display: flex; justify-content: center; margin-bottom: 20px; flex-direction: column; align-items: center; gap: 15px; }
	.control-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center; }
	.toggle-group { display: inline-flex; background: #e1e4e8; padding: 4px; border-radius: 6px; }
	.toggle-btn { padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #57606a; border-radius: 4px; transition: all 0.2s; }
	.toggle-btn:hover { color: #24292e; }
	.toggle-btn.active { background: white; color: #0969da; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
	.checkbox-label { font-weight: 600; color: #24292e; user-select: none; cursor: pointer; display: flex; align-items: center; gap: 5px; }
	.disclaimer-box { font-size: 0.9em; background-color: #fff8c5; padding: 8px 16px; border-radius: 6px; border: 1px solid #d4a72c; color: #4a3b05; max-width: 600px; display: none; margin-top: 10px; }
	.disclaimer-box.visible { display: block; }
	.score-bar-wrapper { width: 100%; height: 24px; background-color: #e1e4e8; border-radius: 6px; overflow: hidden; display: flex; position: relative; cursor: help; }
	.bar-segment { height: 100%; }
	.score-bar-tooltip { display: none; position: absolute; left: 50%; top: -30px; transform: translateX(-50%); background: #24292e; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; white-space: nowrap; z-index: 10; }
	.score-bar-wrapper:hover .score-bar-tooltip { display: block; }
	.result-badge { font-weight: bold; text-transform: capitalize; padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.85em; display: inline-block; min-width: 60px; text-align: center; }
	.result-badge.success { background-color: #2da44e; }
	.result-badge.fail { background-color: #cf222e; }
	.run-dot { width: 12px; height: 12px; display: inline-block; border-radius: 2px; margin-right: 2px; }
	.run-dot.S { background-color: #2da44e; }
	.run-dot.F { background-color: #cf222e; }
	.failure-box { font-size: 0.9em; margin-bottom: 8px; }
	.failure-msg { font-family: "SFMono-Regular", Consolas, monospace; background-color: #f6f8fa; padding: 8px; border-radius: 6px; border: 1px solid #e1e4e8; white-space: pre-wrap; max-height: 100px; overflow-y: auto; }
	.log-link { color: #0969da; text-decoration: none; font-weight: 600; font-size: 0.9em; }
	.log-link:hover { text-decoration: underline; }
	.model-link { text-decoration: none; color: #0969da; font-weight: bold; font-size: 1.05em; }
	.model-link:hover { text-decoration: underline; }
	.task-link { text-decoration: none; color: #24292e; }
	.task-link:hover { color: #0969da; text-decoration: underline; }
	.back-link { display: inline-block; margin-bottom: 1rem; color: #0969da; text-decoration: none; font-weight: 600; }
	.back-link:hover { text-decoration: underline; }
</style>
	
	<script>
		const DATA_URL = "combined_results.jsonl";
		const MODEL_KEYWORDS = {"gemini":"Proprietary"};

		async function loadData() {
			try {
				const response = await fetch(DATA_URL);
				if (!response.ok) throw new Error("Failed to load data file: " + DATA_URL);
				const text = await response.text();
				const rawData = text.trim().split('\n').map(line => {
					try { return JSON.parse(line); } catch (e) { return null; }
				}).filter(x => x); 
				processData(rawData);
				if (window.renderPage) window.renderPage();
			} catch (err) {
				console.error(err);
				const container = document.querySelector('.container');
				if(container) {
					container.innerHTML = 
						'<div style="color:#cf222e; text-align:center; margin-top:50px; background:#fff; padding:2rem; border-radius:6px; border:1px solid #e1e4e8;">' +
						'<h2>Error Loading Data</h2>' +
						'<p>Could not fetch <code>'+DATA_URL+'</code>.</p>' +
						'<p style="color:#57606a;"><strong>Note:</strong> If opening locally, you must run a local server (browsers block file:// access).</p>' +
						'<code style="background:#f6f8fa; padding:5px; border-radius:4px;">python3 -m http.server</code>' +
						'</div>';
				}
			}
		}

		function getModelType(name) {
			const n = name.toLowerCase();
			for (let k in MODEL_KEYWORDS) {
				if (n.includes(k)) return MODEL_KEYWORDS[k];
			}
			return 'Open Source';
		}

		function passAtK(n, c, k) {
			if (n === 0) return 0.0;
			const p = c / n;
			return (1.0 - Math.pow(1.0 - p, k)) * 100;
		}

		function processData(rawData) {
			const cleanedData = rawData.map(item => {
				let res = (item.result || 'fail').toString().toLowerCase();
				let msg = null;
				if (res !== 'success' && item.failures && item.failures.length > 0) {
					msg = item.failures[0].message ? item.failures[0].message.trim() : '';
				}
				return {
					model: item.llmConfig?.model || 'Unknown',
					task: item.name || 'Unknown',
					result: res,
					message: msg
				};
			});

			const grouped = {}; 
			const allTasks = new Set();
			
			cleanedData.forEach(item => {
				const m = item.model;
				const t = item.task;
				allTasks.add(t);
				if (!grouped[m]) grouped[m] = {};
				if (!grouped[m][t]) grouped[m][t] = [];
				grouped[m][t].push(item);
			});

			const leaderboard = [];
			const model_details = {};

			for (const model in grouped) {
				const tasksMap = grouped[model];
				const p1s = [];
				const p5s = [];
				let passAllCount = 0;
				let totalRuns = 0;
				const mRows = [];

				for (const tName in tasksMap) {
					const items = tasksMap[tName];
					const n = items.length;
					const c = items.filter(i => i.result === 'success').length;
					totalRuns += n;
					p1s.push(passAtK(n, c, 1));
					p5s.push(passAtK(n, c, 5));
					if (n > 0 && c === n) passAllCount++;

					items.forEach((item, idx) => {
						mRows.push({
							task: tName,
							result: item.result,
							run: idx + 1,
							message: item.message
						});
					});
				}

				const avgP1 = p1s.length ? p1s.reduce((a,b)=>a+b,0)/p1s.length : 0;
				const avgP5 = p5s.length ? p5s.reduce((a,b)=>a+b,0)/p5s.length : 0;
				const taskCount = Object.keys(tasksMap).length;
				const pAll = taskCount ? (passAllCount / taskCount) * 100 : 0;

				leaderboard.push({
					id: model,
					type: getModelType(model),
					p1: parseFloat(avgP1.toFixed(1)),
					p5: parseFloat(avgP5.toFixed(1)),
					pAll: parseFloat(pAll.toFixed(1)),
					runs: totalRuns,
					tasks: taskCount
				});
				
				mRows.sort((a,b) => (a.task > b.task) ? 1 : (a.task === b.task) ? a.run - b.run : -1);
				model_details[model] = mRows;
			}

			const tasks = [];
			const task_details = {};

			allTasks.forEach(tName => {
				let allRes = [];
				for (const m in grouped) {
					if (grouped[m][tName]) {
						allRes = allRes.concat(grouped[m][tName].map(i => i.result));
					}
				}
				const nTotal = allRes.length;
				const cTotal = allRes.filter(r => r === 'success').length;
				
				tasks.push({
					name: tName,
					p1: parseFloat(passAtK(nTotal, cTotal, 1).toFixed(1)),
					count: nTotal
				});

				const breakdown = [];
				for (const m in grouped) {
					if (grouped[m][tName]) {
						const items = grouped[m][tName];
						const n = items.length;
						const c = items.filter(i => i.result === 'success').length;
						const p1 = passAtK(n, c, 1);
						const runs = items.map((i, idx) => ({ r: idx+1, val: i.result === 'success' ? 'S' : 'F' }));
						breakdown.push({ model: m, p1: parseFloat(p1.toFixed(1)), runs: runs });
					}
				}
				breakdown.sort((a,b) => b.p1 - a.p1);
				task_details[tName] = breakdown;
			});

			leaderboard.sort((a,b) => b.p5 - a.p5);
			tasks.sort((a,b) => a.p1 - b.p1);

			window.PROCESSED_DATA = { leaderboard, tasks, details: model_details, task_details };
		}

		function getHue(percentage) { return (percentage / 100) * 120; }
		
		function createMiniBar(val, hue) {
			return '<div style="height: 6px; width: 100%; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden;"><div style="height: 100%; width: '+val+'%; background-color: hsla('+hue+', 85%, 40%, 1.0);"></div></div>';
		}
		
		function createBar(val, hue) {
			return '<div class="score-bar-wrapper"><div class="bar-segment" style="width: '+val+'%; background-color: hsla('+hue+', 85%, 40%, 1.0);"></div></div>';
		}
		
		function sortTable(table, colIndex) {
			const tbody = table.querySelector('tbody');
			const rows = Array.from(tbody.querySelectorAll('tr'));
			const header = table.querySelector('th[data-idx=\"'+colIndex+'\"]');
			const isAsc = header.classList.contains('asc');
			const dir = isAsc ? -1 : 1;
			rows.sort((a, b) => {
				const aTxt = a.children[colIndex].innerText.trim();
				const bTxt = b.children[colIndex].innerText.trim();
				const aNum = parseFloat(aTxt.replace(/[^0-9.-]+/g,""));
				const bNum = parseFloat(bTxt.replace(/[^0-9.-]+/g,""));
				if (!isNaN(aNum) && !isNaN(bNum) && (aTxt.includes('%') || aTxt.match(/^\\d/))) return (aNum - bNum) * dir;
				return aTxt.localeCompare(bTxt, undefined, {numeric: true}) * dir;
			});
			tbody.innerHTML = '';
			tbody.append(...rows);
			table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
			header.classList.toggle('asc', !isAsc);
			header.classList.toggle('desc', isAsc);
		}
		
		document.addEventListener('DOMContentLoaded', () => {
			loadData();
			document.querySelectorAll('th[data-idx]').forEach(th => {
				th.addEventListener('click', () => sortTable(th.closest('table'), th.dataset.idx));
			});
		});
	</script>
	
</head>
<body>
	<nav class="navbar">
		<a href="index.html" class="nav-brand">k8s-ai-bench</a>
		<div class="nav-links">
			<a href="index.html" class="nav-btn active">Leaderboard</a>
			<a href="tasks.html" class="nav-btn">Tasks</a>
			<a href="about.html" class="nav-btn">About</a>
			<a href="https://github.com/GoogleCloudPlatform/kubectl-ai" class="nav-btn" target="_blank">GitHub &nearr;</a>
		</div>
	</nav>
	<div class="container">
		
		<h1>k8s-ai-bench Leaderboard</h1>
		<div class="intro-container">
			<div class="intro-row"><span class="intro-label">Goal:</span> Determine which LLM is best suited for solving Kubernetes tasks.</div>
			<div class="intro-row"><span class="intro-label">Method:</span> Evaluation against 24 specific tasks in the <a href="https://github.com/GoogleCloudPlatform/kubectl-ai/tree/main/k8s-ai-bench" target="_blank" style="color: #0969da; text-decoration: none;">k8s-ai-bench</a> repository (totaling 120 execution runs per model).</div>
			<div class="intro-row" style="margin-top: 10px; border-top: 1px dashed #e1e4e8; padding-top: 10px;">
				<div class="intro-label" style="margin-bottom: 5px;">Metrics:</div>
				<div class="metric-def"><strong>Pass@1:</strong> The probability of passing a task on the first try. This represents the average performance of the model.</div>
				<div class="metric-def"><strong>Pass@5:</strong> The probability of passing a task within 5 tries. This represents the potential of the model.</div>
				<div class="metric-def"><strong>Pass All 5:</strong> The percent of tasks that passed on every run.</div>
			</div>
		</div>
		
		<div class="controls-area">
			<div class="control-row">
				<span style="font-weight:600; font-size:0.9em;">Metric:</span>
				<div class="toggle-group">
					<button class="toggle-btn" onclick="setMetric('p1')" id="btn-p1">Pass@1</button>
					<button class="toggle-btn active" onclick="setMetric('p5')" id="btn-p5">Pass@5</button>
					<button class="toggle-btn" onclick="setMetric('pAll')" id="btn-pAll">Pass All 5</button>
				</div>
			</div>
			<div class="control-row">
				<span style="font-weight:600; font-size:0.9em;">Filter Models:</span>
				<label class="checkbox-label"><input type="checkbox" id="chk-prop" checked onchange="renderPage()"> Proprietary</label>
				<label class="checkbox-label"><input type="checkbox" id="chk-open" checked onchange="renderPage()"> Open Source</label>
			</div>
			<div class="disclaimer-box" id="pAll-disclaimer">
				<strong>Note:</strong> We are still evaluating whether "Pass All 5" is a robust metric. It represents the percentage of tasks where the model succeeded in every single attempt (Consistency).
			</div>
		</div>
		
		<div style="max-width: 900px; margin: 0 auto;">
			<table id="leaderboard-table">
				<thead>
					<tr>
						<th data-idx="0" style="width: 250px;">Model</th>
						<th data-idx="1">Score</th>
						<th data-idx="2" style="width: 100px;">Type</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<p style="text-align:center; color:#6e7781; margin-top: 2rem;">Click on a model name to view detailed logs.</p>
		
		<script>
			let currentMetric = 'p5';
			function setMetric(metric) {
				currentMetric = metric;
				document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
				document.getElementById('btn-' + metric).classList.add('active');
				const disclaimer = document.getElementById('pAll-disclaimer');
				if (metric === 'pAll') disclaimer.classList.add('visible');
				else disclaimer.classList.remove('visible');
				renderPage();
			}
			window.renderPage = function() {
				if(!window.PROCESSED_DATA) return;
				const tbody = document.querySelector('#leaderboard-table tbody');
				const showProp = document.getElementById('chk-prop').checked;
				const showOpen = document.getElementById('chk-open').checked;
				
				let data = window.PROCESSED_DATA.leaderboard.filter(row => {
					if (row.type === 'Proprietary' && !showProp) return false;
					if (row.type === 'Open Source' && !showOpen) return false;
					return true;
				});
				data.sort((a, b) => b[currentMetric] - a[currentMetric]);
				
				tbody.innerHTML = data.map(row => {
					const val = row[currentMetric];
					const hue = getHue(val);
					return '<tr><td><a href="model.html?id='+encodeURIComponent(row.id)+'" class="model-link">'+row.id+'</a></td>' +
						   '<td><div class="score-container"><div class="score-text" style="font-weight:bold;">'+val+'%</div>' +
						   createBar(val, hue) + '</div></td>' +
						   '<td><span style="font-size:0.85em; color:#57606a;">'+row.type+'</span></td></tr>';
				}).join('');
			}
		</script>
	
	</div>
</body>
</html>